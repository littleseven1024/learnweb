<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>啦拉拉拉</title>
    <style>
        li:hover {
            background-color: brown;
        }
        .selected {
            background-color: cornflowerblue;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <input id="email-input" type="text">
        <ul id="email-sug-wrapper" class="email-sug"></ul>
    </div>
    <script>
        var email_input = document.getElementById("email-input");
        var postfixList = ['163.com', 'gmail.com', '126.com', 'qq.com', '263.net'];
        var ul = document.getElementById("email-sug-wrapper");
        var selectedLi = null;
        var selectnum = 0;

        //监听输入框的输入事件
        email_input.onkeyup = function(event) {
            var e = event || window.event;
            addSugWrapper();
            control();
            if (e.keyCode != 13 && e.keyCode != 38 && e.keyCode != 40) {
                reset();
            }
            var list = ul.querySelectorAll("li");
            if (selectedLi == null) {
                selectedLi = ul.querySelector("li:first-child");
                selectedLi.classList.add("selected");
            }
            for (let i = 0; i < list.length; i++) {
                if (list[i].getAttribute("class") == "selected") {
                    selectedLi = list[i];
                    selectnum = i;
                }   
            }
            //上键
            if (e.keyCode == 38) {
                selectedLi.classList.remove("selected");
                if (selectnum != 0) {
                    selectedLi = list[--selectnum];
                    selectedLi.classList.add("selected");
                    console.log("上移到：" + selectedLi.textContent);
                    
                } else {
                    selectedLi = list[list.length-1];
                    selectedLi.classList.add("selected");
                    selectnum = list.length - 1;
                    console.log("上移到：" + selectedLi.textContent);
                }
            }
            //下键
            if (e.keyCode == 40) {
                selectedLi.classList.remove("selected");
                if (selectnum != list.length -1) {
                    selectedLi = list[++selectnum];
                    selectedLi.classList.add("selected");
                    console.log("下移到：" + selectedLi.textContent);
                } else {
                    selectedLi = list[0];
                    selectedLi.classList.add("selected");
                    selectnum = 0;
                    console.log("下移到：" + selectedLi.textContent);
                }
            }
            //回车键
            if (e.keyCode == 13) {
                email_input.value = selectedLi.textContent;
                hiddenTooltip();
            }
        }

        //重置选中状态
        function reset() {
            var firstLi = ul.querySelector("li:first-child");
            var selectedLi = ul.querySelector("li.selected");
            if (selectedLi != null) {
                if (firstLi != selectedLi) {
                    selectedLi.classList.remove("selected");
                    firstLi.classList.add("selected");
                }
            } else {
                firstLi.classList.add("selected");
            }
        }

        //ul的点击监听事件
        ul.onclick = function (e) {
            console.log(e.target.tagName);

            if (e.target.tagName == "LI") {
                var econtent = e.target.innerHTML;
                email_input.value = econtent;
                hiddenTooltip();
            }
        }

        //获取用户输入
        function getInput() {
            var string = email_input.value;
            return string.trim();
        }

        //生成内容
        function generateContent() {
            var string1 = getInput();
            var emailstring = new Array();
            var a = string1.indexOf("@");
            var string = string1;
            var laststring = "";
            if (a != -1) {
                string = string1.slice(0, a);
                laststring = string1.slice(a + 1);
            }
            for (let i = 0; i < postfixList.length; i++) {
                if (postfixList[i].indexOf(laststring) != -1) {
                    emailstring.push(string + "@" + postfixList[i]);
                }
            }
            return emailstring;
        }

        //添加节点
        function addSugWrapper() {
            while (ul.hasChildNodes() && ul.firstChild != null) {
                ul.removeChild(ul.firstElementChild);
            }
            var emailstring = generateContent();
            for (let i = 0; i < emailstring.length; i++) {
                var li = document.createElement("li");
                li.innerHTML = emailstring[i];
                ul.appendChild(li);
            }
            ul.firstChild.setAttribute("class", "selected");
        }

        //控制ul的显示和隐藏
        function control() {
            var string = getInput();
            if (string.length == 0) {
                hiddenTooltip();
            } else {
                displayTooltip();
            }
        }
        
        //隐藏提示框
        function hiddenTooltip() {
            ul.style.display = "none";
        }
        
        //显示提示框
        function displayTooltip() {
            ul.style.display = "inline";
        }
    </script>
</body>

</html>